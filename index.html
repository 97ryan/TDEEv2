<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for iOS Home Screen App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ryan's TDEE Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel to translate JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>
    <style>
        /* Base dark mode background to prevent flash of white on load */
        body { background-color: #1c1c1e; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Destructure necessary components from the global objects provided by the CDNs
        const { useState, useEffect, useMemo } = React;

        // --- Constants & Helpers ---
        const KCAL_PER_KG = 7716; // 3500 kcal/lb * 2.20462
        const MS_PER_DAY = 24 * 60 * 60 * 1000;
        const byDate = (a, b) => new Date(a.date) - new Date(b.date);

        // Ordinary-least-squares slope (kg per day) using actual dates
        function slopeKgPerDay(entries) {
            const n = entries.length;
            if (n < 2) return null;
            const t0 = new Date(entries[0].date).getTime();
            const xs = entries.map(e => (new Date(e.date).getTime() - t0) / MS_PER_DAY);
            const ys = entries.map(e => e.weight);
            const mx = xs.reduce((a, b) => a + b, 0) / n;
            const my = ys.reduce((a, b) => a + b, 0) / n;
            let num = 0, den = 0;
            for (let i = 0; i < n; i++) {
                const dx = xs[i] - mx;
                num += dx * (ys[i] - my);
                den += dx * dx;
            }
            return den === 0 ? null : num / den; // kg/day
        }

        // --- Helper Icons ---
        const WeightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-sky-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.8 19.3c-1-3.3-3.3-5.3-6.8-5.3s-5.8 2-6.8 5.3"/><path d="M9.5 9.5a2.5 2.5 0 1 1 5 0"/><rect x="2" y="3" width="20" height="18" rx="2"/></svg>;
        const CalorieIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-rose-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69z"/><path d="M12 12.69l-3.37 3.37"/></svg>;
        const TargetIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-emerald-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const InfoIcon = ({ onClick }) => <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-zinc-300 cursor-pointer" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>;

        // Formatting helpers
        const formatDate = (d) => new Date(d).toISOString().slice(0, 10);
        const formatDateDDMMYY = (d) => {
            const dt = new Date(d);
            const y = dt.getFullYear();
            const m = `${dt.getMonth()+1}`.padStart(2, '0');
            const day = `${dt.getDate()}`.padStart(2, '0');
            return `${y}-${m}-${day}`;
        };
        const prettyDate = (iso) => {
            const d = new Date(iso);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2);
            return `${day}/${month}/${year}`;
        };

        // Storage helpers
        const STORAGE_KEY = "tdee-tracker-entries";
        const loadEntries = () => {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch { return []; }
        };
        const saveEntries = (entries) => {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); } catch {}
        };

        // Seed today date if empty
        const todayISO = () => new Date().toISOString().slice(0,10);

        function App() {
            const [entries, setEntries] = useState(loadEntries());
            const [selectedDate, setSelectedDate] = useState(todayISO());
            const [weightInput, setWeightInput] = useState("");
            const [caloriesInput, setCaloriesInput] = useState("");
            const [tdeeInput, setTdeeInput] = useState("");
            const [goal, setGoal] = useState(0); // kg/week
            const [targetWeight, setTargetWeight] = useState("");

            useEffect(() => saveEntries(entries), [entries]);

            const tdee = useMemo(() => {
                const vals = entries.filter(e => Number.isFinite(e.tdee)).map(e => e.tdee);
                if (vals.length === 0) return null;
                return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
            }, [entries]);

            // ---------- Weekly change status (window last 15 weigh-ins) ----------
            const weeklyStatus = useMemo(() => {
                const completeEntries = entries.filter(e => e.date && e.weight != null).sort(byDate);
                if (completeEntries.length < 2) return 'Needs more data';
                
                const sorted = [...completeEntries].sort(byDate);
                const recent = sorted.slice(-15); // CHANGED from -14 → -15
                if (recent.length < 2) return 'Preliminary Estimate';
                
                const spanDays = (new Date(recent[recent.length-1].date) - new Date(recent[0].date)) / MS_PER_DAY;

                let hasGap = false;
                for (let i=1; i<recent.length; i++){
                    const diff = Math.round((new Date(recent[i].date) - new Date(recent[i-1].date)) / MS_PER_DAY);
                    if (diff > 3) { hasGap = true; break; } // Allow for a couple missed days
                }
                if (hasGap) return 'Gaps in logs — estimate may vary';
                return spanDays >= 10 ? 'Reliable Estimate' : 'Preliminary Estimate';
            }, [entries]);

            const calorieTarget = useMemo(() => {
                if (!tdee) return null;
                return Math.round(tdee + (goal * KCAL_PER_KG) / 7);
            }, [tdee, goal]);
            
            const averageWeeklyChange = useMemo(() => {
                const weightEntries = entries.filter(e => e.weight != null);
                if (weightEntries.length < 2) return null;

                const sorted = [...weightEntries].sort(byDate);
                // Use last 15 entries with weight data (CHANGED)
                const recent = sorted.slice(-15); 
                if (recent.length < 2) return null;

                const slope = slopeKgPerDay(recent);
                return slope == null ? null : slope * 7; // kg/week
            }, [entries]);

            const projectedTargetDate = useMemo(() => {
                const tw = parseFloat(targetWeight);
                if (!Number.isFinite(tw)) return "—";
                const weightEntries = entries.filter(e => e.weight != null).sort(byDate);
                if (weightEntries.length === 0) return "—";
                const last = weightEntries[weightEntries.length - 1];
                const change = averageWeeklyChange;
                if (change == null || Math.abs(change) < 1e-6) return "—";
                const weightDiff = tw - last.weight;
                const weeksNeeded = weightDiff / averageWeeklyChange;
                if (!isFinite(weeksNeeded) || weeksNeeded <= 0) return "N/A";

                const futureDate = new Date(new Date(last.date).getTime() + weeksNeeded * 7 * MS_PER_DAY);
                return formatDateDDMMYY(futureDate);
            }, [entries, targetWeight, averageWeeklyChange]);
            
            const entryForSelectedDateExists = useMemo(() => {
                return entries.some(e => e.date === formatDate(selectedDate));
            }, [selectedDate, entries]);

            const handleDeleteEntry = () => {
                const dateStr = formatDate(selectedDate);
                const updatedEntries = entries.filter(entry => entry.date !== dateStr);
                setEntries(updatedEntries);
            };

            const handleAddEntry = (e) => {
                e.preventDefault();
                const weight = parseFloat(weightInput);
                const calories = parseInt(caloriesInput, 10);
                
                const newWeight = !isNaN(weight) && weight > 0 ? weight : null;
                const newCalories = !isNaN(calories) && calories > 0 ? calories : null;
                const newTdee = tdeeInput !== "" ? parseInt(tdeeInput, 10) : null;

                const dateStr = formatDate(selectedDate);
                const newEntry = { date: dateStr, weight: newWeight, calories: newCalories, tdee: newTdee };

                const updated = [...entries.filter(e => e.date !== dateStr), newEntry].sort(byDate);
                setEntries(updated);

                setWeightInput("");
                setCaloriesInput("");
                setTdeeInput("");
            };

            const handleRemoveEntry = (date) => {
                setEntries(entries.filter(e => e.date !== date));
            };

            const handleClearAll = () => {
                if (!confirm("Clear all entries?")) return;
                setEntries([]);
            };

            // CSV export/import
            const toCSV = (ents) => {
                const header = "Date,Weight,Calories,TDEE";
                const rows = ents.slice().sort(byDate).map(e => [e.date, e.weight ?? "", e.calories ?? "", e.tdee ?? ""].join(","));
                return [header, ...rows].join("\n");
            };
            const parseCSV = (text) => {
                const lines = text.trim().split(/\r?\n/);
                const header = lines[0].split(",").map(s=>s.trim().toLowerCase());
                const idx = {
                    date: header.indexOf("date"),
                    weight: header.indexOf("weight"),
                    calories: header.indexOf("calories"),
                    tdee: header.indexOf("tdee"),
                };
                const out = [];
                for (let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(",").map(s=>s.trim());
                    const date = idx.date >= 0 ? cols[idx.date] : "";
                    const weight = idx.weight >= 0 && cols[idx.weight] !== "" ? Number(cols[idx.weight]) : null;
                    const calories = idx.calories >= 0 && cols[idx.calories] !== "" ? Number(cols[idx.calories]) : null;
                    const tdee = idx.tdee >= 0 && cols[idx.tdee] !== "" ? Number(cols[idx.tdee]) : null;
                    if (!date) continue;
                    out.push({ date, weight, calories, tdee });
                }
                return out;
            };

            function AppUI() {
                const sortedDesc = entries.slice().sort((a,b)=>new Date(b.date) - new Date(a.date));

                return (
                    <div className="max-w-5xl mx-auto px-4 py-6 text-zinc-100">
                        <div className="flex items-center justify-between gap-3">
                            <div>
                                <h1 className="text-xl font-bold">TDEE Tracker</h1>
                                <div className="text-xs text-zinc-400">Local-first • Offline • Metric</div>
                            </div>
                            <div className="text-xs text-zinc-400 flex items-center gap-2">
                                <span>Weekly change window: <span className="font-semibold text-zinc-200">last 15 weigh-ins</span></span>
                                <span className="px-2 py-0.5 border border-zinc-700 rounded-full">{weeklyStatus}</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="flex items-center gap-2 text-zinc-300">
                                    <WeightIcon /><div className="font-semibold">Average Weekly Change</div>
                                </div>
                                <div className="text-2xl font-bold mt-1">
                                    {averageWeeklyChange == null ? <span className="text-zinc-500">—</span> :
                                        <span className={averageWeeklyChange >= 0 ? "text-emerald-300" : "text-rose-300"}>
                                            {averageWeeklyChange.toFixed(2)} kg/week
                                        </span>
                                    }
                                </div>
                                <div className="text-xs text-zinc-400 mt-1">OLS trend on your last 15 weights × 7</div>
                            </div>

                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="flex items-center gap-2 text-zinc-300">
                                    <CalorieIcon /><div className="font-semibold">Calorie Target</div>
                                    <InfoIcon onClick={()=>alert("Target = TDEE + (goal kg/week × 7716) / 7")} />
                                </div>
                                <div className="text-2xl font-bold mt-1">
                                    {calorieTarget == null ? <span className="text-zinc-500">—</span> : `${calorieTarget} kcal/day`}
                                </div>
                                <div className="text-xs text-zinc-400 mt-1">Set goal below to compute</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="text-xs text-zinc-400 mb-2">Log entry</div>
                                <form onSubmit={handleAddEntry} className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <input type="date" className="bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                           value={selectedDate} onChange={e=>setSelectedDate(e.target.value)}/>
                                    <input type="number" step="0.01" placeholder="Weight (kg)" className="bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                           value={weightInput} onChange={e=>setWeightInput(e.target.value)} />
                                    <input type="number" step="1" placeholder="Calories (kcal)" className="bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                           value={caloriesInput} onChange={e=>setCaloriesInput(e.target.value)} />
                                    <input type="number" step="1" placeholder="TDEE (kcal)" className="bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                           value={tdeeInput} onChange={e=>setTdeeInput(e.target.value)} />
                                    <button className="col-span-2 md:col-span-1 bg-indigo-500 hover:bg-indigo-600 rounded-lg px-3 py-2 font-semibold">Save / Update</button>
                                    <button type="button" className="bg-zinc-800 hover:bg-zinc-700 rounded-lg px-3 py-2" onClick={handleDeleteEntry} disabled={!entryForSelectedDateExists}>Delete this date</button>
                                    <button type="button" className="bg-zinc-800 hover:bg-zinc-700 rounded-lg px-3 py-2" onClick={handleClearAll}>Clear all</button>
                                </form>
                            </div>

                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="text-xs text-zinc-400 mb-2">Goal / Projection</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <div className="text-xs text-zinc-400">Goal (kg/week)</div>
                                        <input type="number" step="0.01" className="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                               value={goal} onChange={e=>setGoal(parseFloat(e.target.value)||0)} />
                                    </div>
                                    <div>
                                        <div className="text-xs text-zinc-400">Target Weight (kg)</div>
                                        <input type="number" step="0.01" className="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2"
                                               value={targetWeight} onChange={e=>setTargetWeight(e.target.value)} />
                                    </div>
                                    <div className="col-span-2 text-sm text-zinc-300">Projected date at current Δ: <span className="font-semibold">{projectedTargetDate}</span></div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                            <div className="text-xs text-zinc-400 mb-2">Progress Table</div>
                            <div className="overflow-auto rounded-lg border border-zinc-800">
                                <table className="w-full text-sm">
                                    <thead className="bg-zinc-900 sticky top-0">
                                        <tr>
                                            <th className="text-left p-2">Date</th>
                                            <th className="text-left p-2">Weight</th>
                                            <th className="text-left p-2">Calories</th>
                                            <th className="text-left p-2">TDEE</th>
                                            <th className="text-right p-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedDesc.map(e => (
                                            <tr key={e.date} className="odd:bg-zinc-900/40">
                                                <td className="p-2">{e.date}</td>
                                                <td className="p-2">{e.weight ?? <span className="text-zinc-500">—</span>}</td>
                                                <td className="p-2">{e.calories ?? <span className="text-zinc-500">—</span>}</td>
                                                <td className="p-2">{e.tdee ?? <span className="text-zinc-500">—</span>}</td>
                                                <td className="p-2 text-right">
                                                    <button className="px-2 py-1 text-xs rounded border border-zinc-700 hover:bg-zinc-800" onClick={()=>handleRemoveEntry(e.date)}>Delete</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="text-xs text-zinc-400 mb-2">Import CSV</div>
                                <CSVImport entries={entries} setEntries={setEntries} parseCSV={parseCSV}/>
                            </div>
                            <div className="p-4 rounded-xl border border-zinc-800 bg-zinc-900/40">
                                <div className="text-xs text-zinc-400 mb-2">Export CSV</div>
                                <button className="bg-zinc-800 hover:bg-zinc-700 rounded-lg px-3 py-2" onClick={()=>{
                                    const blob = new Blob([toCSV(entries)], { type: "text/csv" });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement("a");
                                    a.href = url;
                                    a.download = "tdee-data.csv";
                                    a.click();
                                    URL.revokeObjectURL(url);
                                }}>Download CSV</button>
                            </div>
                        </div>
                    </div>
                );
            }

            function CSVImport({ entries, setEntries, parseCSV }) {
                const [text, setText] = useState("");
                const merge = () => {
                    const arr = parseCSV(text);
                    if (!arr.length) return;
                    const map = new Map(entries.map(e => [e.date, e]));
                    for (const e of arr) map.set(e.date, e);
                    setEntries([...map.values()].sort(byDate));
                    setText("");
                };
                return (
                    <div>
                        <textarea rows={8} value={text} onChange={e=>setText(e.target.value)}
                                  placeholder={"Date,Weight,Calories,TDEE\n2025-09-10,70.6,3121,2772\n..."}
                                  className="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-2 py-2 font-mono text-xs"/>
                        <div className="mt-2">
                            <button className="bg-indigo-500 hover:bg-indigo-600 rounded-lg px-3 py-2 font-semibold" onClick={merge}>Import & Merge</button>
                        </div>
                    </div>
                );
            }

            ReactDOM.createRoot(document.getElementById('root')).render(<AppUI />);
        }
        // Mount app
        App();
    </script>
</body>
</html>

