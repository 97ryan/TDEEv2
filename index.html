<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tags for iOS Home Screen App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TDEE Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel to translate JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>
    <!-- FileSaver.js for exporting data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Base dark mode background to prevent flash of white on load */
        body { background-color: #1c1c1e; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Destructure necessary components from the global objects provided by the CDNs
        const { useState, useEffect, useMemo } = React;

        // --- Helper Icons ---
        const WeightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3 h-6 w-6 text-gray-400"><path d="M12 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm0 2c2.7 0 8 1.3 8 4v2H4v-2c0-2.7 5.3-4 8-4z"/><path d="M20.8 19.3c-1-3.3-3.3-5.3-6.8-5.3s-5.8 2-6.8 5.3"/></svg>;
        const CalorieIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3 h-6 w-6 text-gray-400"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69z"/><path d="M12 12.69l-3.37 3.37"/></svg>;
        const InfoIcon = ({ onClick }) => <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block h-4 w-4 ml-1 text-gray-500 hover:text-gray-300 cursor-pointer"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
        const ChevronLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const ChevronRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;

        // --- Helper Functions ---
        const formatDate = (date) => date.toISOString().split('T')[0];
        const areDatesEqual = (date1, date2) => formatDate(date1) === formatDate(date2);

        // --- Calendar Component ---
        const Calendar = ({ selectedDate, setSelectedDate, entries }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));

            useEffect(() => {
                setCurrentMonth(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));
            }, [selectedDate]);

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
            
            const entryDates = useMemo(() => new Set(entries.map(e => e.date)), [entries]);

            const handlePrevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
            const handleNextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));

            return (
                <div className="bg-[#2c2c2e] rounded-xl shadow-md p-4 border border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-gray-600"><ChevronLeftIcon /></button>
                        <h3 className="font-bold text-lg">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                        <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-gray-600"><ChevronRightIcon /></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-sm">
                        {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, index) => <div key={`${day}-${index}`} className="font-semibold text-gray-400">{day}</div>)}
                        {Array.from({ length: firstDayOfMonth }).map((_, i) => <div key={`empty-${i}`}></div>)}
                        {Array.from({ length: daysInMonth }).map((_, day) => {
                            const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day + 1);
                            const dateStr = formatDate(date);
                            const isSelected = areDatesEqual(date, selectedDate);
                            const hasEntry = entryDates.has(dateStr);
                            
                            return (
                                <button
                                    key={day}
                                    onClick={() => setSelectedDate(date)}
                                    className={`relative w-9 h-9 flex items-center justify-center rounded-full transition-colors ${isSelected ? 'bg-indigo-600 text-white' : 'hover:bg-gray-600'}`}
                                >
                                    {day + 1}
                                    {hasEntry && <span className="absolute bottom-1 h-1 w-1 bg-green-400 rounded-full"></span>}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        // --- Confirmation Modal Component ---
        const ConfirmationModal = ({ onConfirm, onCancel }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-[#2c2c2e] rounded-xl p-6 border border-gray-700 shadow-lg text-center">
                        <h3 className="text-lg font-bold text-white mb-4">Are you sure?</h3>
                        <p className="text-gray-300 mb-6">This will permanently delete all your data. This action cannot be undone.</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={onCancel} className="bg-gray-600 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-500">Cancel</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [entries, setEntries] = useState([]);
            const [goal, setGoal] = useState(-0.5);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [weightInput, setWeightInput] = useState('');
            const [caloriesInput, setCaloriesInput] = useState('');
            const [view, setView] = useState('log');
            const [showInfo, setShowInfo] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);

            useEffect(() => {
                try {
                    const savedEntries = JSON.parse(localStorage.getItem('tdeeAppEntries') || '[]');
                    const savedGoal = parseFloat(localStorage.getItem('tdeeAppGoal') || '-0.5');
                    if (Array.isArray(savedEntries)) setEntries(savedEntries);
                    if (!isNaN(savedGoal)) setGoal(savedGoal);
                } catch (error) { console.error("Failed to load data", error); }
            }, []);

            useEffect(() => {
                try {
                    localStorage.setItem('tdeeAppEntries', JSON.stringify(entries));
                    localStorage.setItem('tdeeAppGoal', goal.toString());
                } catch (error) { console.error("Failed to save data", error); }
            }, [entries, goal]);

            useEffect(() => {
                const entryForDate = entries.find(e => e.date === formatDate(selectedDate));
                setWeightInput(entryForDate ? entryForDate.weight.toString() : '');
                setCaloriesInput(entryForDate ? entryForDate.calories.toString() : '');
            }, [selectedDate, entries]);

            const tdee = useMemo(() => {
                if (entries.length < 2) return null;
                const sorted = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
                const period = sorted.length > 28 ? sorted.slice(-28) : sorted;
                const first = period[0];
                const last = period[period.length - 1];
                const days = (new Date(last.date).getTime() - new Date(first.date).getTime()) / (1000 * 3600 * 24);
                if (days < 1) return null;
                const weightChange = last.weight - first.weight;
                const calChange = weightChange * 7700;
                const calConsumed = period.reduce((sum, e) => sum + e.calories, 0);
                return Math.round((calConsumed - calChange) / days);
            }, [entries]);

            const calculationStatus = useMemo(() => {
                if (entries.length < 2) return 'Needs more data';
                if (entries.length < 14) return 'Preliminary Estimate';
                return 'Reliable Estimate';
            }, [entries]);

            const calorieTarget = useMemo(() => {
                if (!tdee) return null;
                return Math.round(tdee + (goal * 7700) / 7);
            }, [tdee, goal]);

            const trendsData = useMemo(() => {
                if (entries.length < 14) return [];
                const sorted = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
                const dataWithTDEE = [];
                for (let i = 13; i < sorted.length; i++) {
                    const period = sorted.slice(i - 13, i + 1);
                    const first = period[0];
                    const last = period[period.length - 1];
                    const days = (new Date(last.date).getTime() - new Date(first.date).getTime()) / (1000 * 3600 * 24);
                    if (days > 0) {
                        const weightChange = last.weight - first.weight;
                        const calChange = weightChange * 7700;
                        const calConsumed = period.reduce((sum, e) => sum + e.calories, 0);
                        const calculatedTdee = Math.round((calConsumed - calChange) / days);
                        dataWithTDEE.push({ ...last, date: new Date(last.date).toLocaleDateString('en-CA'), calculatedTdee });
                    }
                }
                return dataWithTDEE;
            }, [entries]);

            const handleAddEntry = (e) => {
                e.preventDefault();
                const weight = parseFloat(weightInput);
                const calories = parseInt(caloriesInput, 10);
                if (isNaN(weight) || isNaN(calories) || weight <= 0 || calories <= 0) return;
                const dateStr = formatDate(selectedDate);
                const existingIndex = entries.findIndex(e => e.date === dateStr);
                let updatedEntries;
                if (existingIndex > -1) {
                    updatedEntries = [...entries];
                    updatedEntries[existingIndex] = { date: dateStr, weight, calories };
                } else {
                    updatedEntries = [...entries, { date: dateStr, weight, calories }];
                }
                setEntries(updatedEntries.sort((a, b) => new Date(a.date) - new Date(b.date)));
            };

            const handleGoalChange = (e) => {
                const newGoal = parseFloat(e.target.value);
                if (!isNaN(newGoal) && newGoal >= -1 && newGoal <= 1) setGoal(newGoal);
            };
            
            const handleExport = (format) => {
                if (entries.length === 0) return;
                const filename = `tdee-data-${new Date().toISOString().replace(/[:.]/g, '-')}`;
                if (format === 'json') {
                    const blob = new Blob([JSON.stringify({ goal, entries }, null, 2)], { type: 'application/json' });
                    window.saveAs(blob, `${filename}.json`);
                } else {
                    const csv = [ "date,weight,calories", ...entries.map(e => `${e.date},${e.weight},${e.calories}`) ].join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    window.saveAs(blob, `${filename}.csv`);
                }
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        if (file.name.endsWith('.json')) {
                            const data = JSON.parse(content);
                            if (data && Array.isArray(data.entries) && typeof data.goal === 'number') {
                                setEntries(data.entries.sort((a, b) => new Date(a.date) - new Date(b.date)));
                                setGoal(data.goal);
                            }
                        } else if (file.name.endsWith('.csv')) {
                            const [header, ...lines] = content.split('\n').filter(l => l.trim());
                            const imported = lines.map(line => {
                                const [date, weight, calories] = line.split(',');
                                return { date, weight: parseFloat(weight), calories: parseInt(calories) };
                            });
                            if (imported.every(e => e.date && !isNaN(e.weight) && !isNaN(e.calories))) {
                                setEntries(imported.sort((a, b) => new Date(a.date) - new Date(b.date)));
                            }
                        }
                    } catch (error) { console.error("Import failed:", error); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };
            
            const handleConfirmClear = () => {
                setEntries([]);
                setShowClearConfirm(false);
            };

            return (
                <div className="bg-[#1c1c1e] min-h-screen font-sans text-gray-200">
                    {showClearConfirm && <ConfirmationModal onConfirm={handleConfirmClear} onCancel={() => setShowClearConfirm(false)} />}
                    <div className="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
                        <header className="text-center mb-6">
                            <h1 className="text-4xl font-bold text-white">Adaptive TDEE Tracker</h1>
                        </header>
                        <main>
                            <div className="bg-[#2c2c2e] rounded-xl shadow-lg p-6 mb-6 border border-gray-700">
                                <h2 className="text-lg font-semibold text-gray-400 text-center mb-2">Daily Calorie Target</h2>
                                <div className="text-center">
                                    {calorieTarget ? (
                                        <>
                                            <p className="text-5xl font-bold text-green-400">{calorieTarget} <span className="text-2xl font-medium text-gray-400">kcal</span></p>
                                            <p className="text-sm text-gray-500 mt-2">Based on a TDEE of {tdee} kcal/day ({calculationStatus})</p>
                                        </>
                                    ) : (
                                        <div>
                                            <p className="text-xl font-medium text-gray-400 animate-pulse">
                                                Calculating... 
                                                <InfoIcon onClick={() => setShowInfo(!showInfo)} />
                                            </p>
                                            {showInfo && (
                                                <div className="mt-2 text-sm text-left text-gray-400 bg-gray-700/50 p-3 rounded-lg">
                                                    <p>This app calculates your TDEE based on your weight change and calorie intake.</p>
                                                    <p className="mt-1">&bull; An initial estimate requires at least 2 entries.</p>
                                                    <p className="mt-1">&bull; The calculation becomes more reliable after 14 days.</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="mb-6">
                                <div className="flex justify-center border-b border-gray-700">
                                    <button onClick={() => setView('log')} className={`px-4 py-2 text-lg font-semibold ${view === 'log' ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-gray-400'}`}>Daily Log</button>
                                    <button onClick={() => setView('trends')} className={`px-4 py-2 text-lg font-semibold ${view === 'trends' ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-gray-400'}`}>Trends</button>
                                </div>
                            </div>
                            {view === 'log' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <Calendar selectedDate={selectedDate} setSelectedDate={setSelectedDate} entries={entries} />
                                    <div className="bg-[#2c2c2e] rounded-xl shadow-md p-6 border border-gray-700">
                                        <h2 className="text-xl font-bold mb-4 text-white">Log for {selectedDate.toLocaleDateString()}</h2>
                                        <form onSubmit={handleAddEntry} className="space-y-4">
                                            <div>
                                                <label htmlFor="weight" className="block text-sm font-medium text-gray-300 mb-1">Weight (kg)</label>
                                                <div className="flex items-center"><WeightIcon /><input type="number" id="weight" step="0.1" value={weightInput} onChange={(e) => setWeightInput(e.target.value)} placeholder="e.g., 70.5" className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white"/></div>
                                            </div>
                                            <div>
                                                <label htmlFor="calories" className="block text-sm font-medium text-gray-300 mb-1">Calories (kcal)</label>
                                                <div className="flex items-center"><CalorieIcon /><input type="number" id="calories" step="10" value={caloriesInput} onChange={(e) => setCaloriesInput(e.target.value)} placeholder="e.g., 2100" className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white"/></div>
                                            </div>
                                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Save Entry</button>
                                        </form>
                                    </div>
                                </div>
                            )}
                            {view === 'trends' && (
                                <div className="space-y-8">
                                    {trendsData.length > 0 ? (
                                        <>
                                            <div className="bg-[#2c2c2e] rounded-xl p-4 border border-gray-700"><h2 className="text-xl font-bold text-white mb-4">Weight Trend (kg)</h2><Recharts.ResponsiveContainer width="100%" height={300}><Recharts.AreaChart data={trendsData}><Recharts.CartesianGrid stroke="#4a4a4a" /><Recharts.XAxis dataKey="date" stroke="#9ca3af" /><Recharts.YAxis stroke="#9ca3af" domain={['dataMin - 1', 'dataMax + 1']} /><Recharts.Tooltip contentStyle={{ backgroundColor: '#2c2c2e' }} /><Recharts.Area type="monotone" dataKey="weight" stroke="#8884d8" fill="#8884d8" fillOpacity={0.3} /></Recharts.AreaChart></Recharts.ResponsiveContainer></div>
                                            <div className="bg-[#2c2c2e] rounded-xl p-4 border border-gray-700"><h2 className="text-xl font-bold text-white mb-4">Calorie Intake Trend (kcal)</h2><Recharts.ResponsiveContainer width="100%" height={300}><Recharts.AreaChart data={trendsData}><Recharts.CartesianGrid stroke="#4a4a4a" /><Recharts.XAxis dataKey="date" stroke="#9ca3af" /><Recharts.YAxis stroke="#9ca3af" domain={['dataMin - 100', 'dataMax + 100']} /><Recharts.Tooltip contentStyle={{ backgroundColor: '#2c2c2e' }} /><Recharts.Area type="monotone" dataKey="calories" stroke="#82ca9d" fill="#82ca9d" fillOpacity={0.3} /></Recharts.AreaChart></Recharts.ResponsiveContainer></div>
                                            <div className="bg-[#2c2c2e] rounded-xl p-4 border border-gray-700"><h2 className="text-xl font-bold text-white mb-4">Adaptive TDEE Trend (kcal)</h2><Recharts.ResponsiveContainer width="100%" height={300}><Recharts.AreaChart data={trendsData}><Recharts.CartesianGrid stroke="#4a4a4a" /><Recharts.XAxis dataKey="date" stroke="#9ca3af" /><Recharts.YAxis stroke="#9ca3af" domain={['dataMin - 100', 'dataMax + 100']} /><Recharts.Tooltip contentStyle={{ backgroundColor: '#2c2c2e' }} /><Recharts.Area type="monotone" dataKey="calculatedTdee" stroke="#ff7300" fill="#ff7300" fillOpacity={0.3} /></Recharts.AreaChart></Recharts.ResponsiveContainer></div>
                                        </>
                                    ) : (
                                        <div className="text-center py-10 bg-[#2c2c2e] rounded-xl"><p className="text-gray-400">Not enough data to show trends. Keep logging for at least 14 days.</p></div>
                                    )}
                                </div>
                            )}
                            <div className="bg-[#2c2c2e] rounded-xl shadow-md p-6 mt-6 border border-gray-700">
                                <h2 className="text-xl font-bold mb-4 text-white">Settings</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300">Weekly Weight Change Goal (kg)</label>
                                        <div className="flex items-center space-x-4 mt-2">
                                            <input type="number" min="-1" max="1" step="0.1" value={goal} onChange={handleGoalChange} className="w-24 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-center"/>
                                            <input type="range" min="-1" max="1" step="0.1" value={goal} onChange={handleGoalChange} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"/>
                                        </div>
                                        <div className="text-center mt-2">
                                            <span className={`font-bold text-lg ${goal < 0 ? 'text-blue-400' : goal > 0 ? 'text-red-400' : 'text-gray-200'}`}>{goal > 0 ? `Gain ${goal.toFixed(1)} kg/week` : goal < 0 ? `Lose ${Math.abs(goal).toFixed(1)} kg/week` : 'Maintain Weight'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300">Data Management</label>
                                        <div className="grid grid-cols-2 gap-2 mt-2">
                                            <button onClick={() => handleExport('json')} className="bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500">Export JSON</button>
                                            <button onClick={() => handleExport('csv')} className="bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500">Export CSV</button>
                                            <label className="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 text-center cursor-pointer">Import<input type="file" accept=".json, .csv" onChange={handleImport} className="hidden" /></label>
                                            <button onClick={() => setShowClearConfirm(true)} className="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">Clear Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </main>
                        <footer className="text-center mt-8 text-gray-500 text-sm">
                            <p>Built for offline use. All data is stored on your device.</p>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
